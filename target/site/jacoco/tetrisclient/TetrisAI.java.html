<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TetrisAI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JavaTetrisClient</a> &gt; <a href="index.source.html" class="el_package">tetrisclient</a> &gt; <span class="el_source">TetrisAI.java</span></div><h1>TetrisAI.java</h1><pre class="source lang-java linenums">package tetrisclient;

public class TetrisAI {

    private final PlayScreen screen;

<span class="nc" id="L7">    public TetrisAI(PlayScreen screen) {</span>
<span class="nc" id="L8">        this.screen = screen;</span>
<span class="nc" id="L9">    }</span>

    public void start() {
<span class="nc" id="L12">        new Thread(() -&gt; {</span>
            while (true) {
<span class="nc" id="L14">                try { Thread.sleep(1500); } catch (InterruptedException e) { return; }</span>
<span class="nc" id="L15">                PlayScreen.Tetromino current = screen.getCurrentTetromino();</span>
<span class="nc bnc" id="L16" title="All 2 branches missed.">                if (current == null) continue;</span>

<span class="nc" id="L18">                PlayScreen.Tetromino simulated = current.cloneTetromino();</span>
<span class="nc" id="L19">                Move bestMove = findBestMove(simulated);</span>

<span class="nc bnc" id="L21" title="All 2 branches missed.">                if (bestMove != null) {</span>
                    //rotation
<span class="nc bnc" id="L23" title="All 2 branches missed.">                    for (int i = 0; i &lt; bestMove.rotation; i++) current.rotate();</span>

                    // Move horizontally
<span class="nc bnc" id="L26" title="All 2 branches missed.">                    while (current.getX() &lt; bestMove.column) current.move(1, 0);</span>
<span class="nc bnc" id="L27" title="All 2 branches missed.">                    while (current.getX() &gt; bestMove.column) current.move(-1, 0);</span>

                    // Dropping piece
<span class="nc bnc" id="L30" title="All 2 branches missed.">                    while (current.move(0, 1)) {}</span>
                }
<span class="nc" id="L32">            }</span>
<span class="nc" id="L33">        }).start();</span>
<span class="nc" id="L34">    }</span>

    private Move findBestMove(PlayScreen.Tetromino tetro) {
<span class="nc" id="L37">        int[][] board = getBoardMatrix();</span>
<span class="nc" id="L38">        int bestScore = Integer.MIN_VALUE;</span>
<span class="nc" id="L39">        Move bestMove = null;</span>

<span class="nc bnc" id="L41" title="All 2 branches missed.">        for (int rotation = 0; rotation &lt; 4; rotation++) {</span>
<span class="nc" id="L42">            PlayScreen.Tetromino temp = tetro.cloneTetromino();</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">            for (int r = 0; r &lt; rotation; r++) temp.rotate();</span>

<span class="nc bnc" id="L45" title="All 2 branches missed.">            for (int col = 0; col &lt; screen.getColumns(); col++) {</span>
<span class="nc" id="L46">                PlayScreen.Tetromino temp2 = temp.cloneTetromino();</span>
<span class="nc" id="L47">                int dx = col - temp2.getX();</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">                if (!temp2.move(dx, 0)) continue;</span>

                // Drop to bottom
<span class="nc bnc" id="L51" title="All 2 branches missed.">                while (temp2.move(0,1)) {}</span>

<span class="nc" id="L53">                int[][] simulatedBoard = copyBoard(board);</span>
<span class="nc" id="L54">                placePiece(simulatedBoard, temp2);</span>

<span class="nc" id="L56">                int score = evaluateBoard(simulatedBoard);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">                if (score &gt; bestScore) {</span>
<span class="nc" id="L58">                    bestScore = score;</span>
<span class="nc" id="L59">                    bestMove = new Move(col, temp2.getY(), rotation);</span>
                }
            }
        }
<span class="nc" id="L63">        return bestMove;</span>
    }

    private int[][] getBoardMatrix() {
<span class="nc" id="L67">        int[][] board = new int[screen.getRows()][screen.getColumns()];</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        for (javafx.scene.shape.Rectangle r : screen.getLockedBlocks()) {</span>
<span class="nc" id="L69">            int row = (int) (r.getY() / screen.getCellSize());</span>
<span class="nc" id="L70">            int col = (int) (r.getX() / screen.getCellSize());</span>
<span class="nc" id="L71">            board[row][col] = 1;</span>
<span class="nc" id="L72">        }</span>
<span class="nc" id="L73">        return board;</span>
    }

    private void placePiece(int[][] board, PlayScreen.Tetromino tetro) {
<span class="nc bnc" id="L77" title="All 2 branches missed.">        for (int[] cell : tetro.getShape()) {</span>
<span class="nc" id="L78">            int x = tetro.getX() + cell[0];</span>
<span class="nc" id="L79">            int y = tetro.getY() + cell[1];</span>
<span class="nc bnc" id="L80" title="All 8 branches missed.">            if (y &gt;= 0 &amp;&amp; y &lt; board.length &amp;&amp; x &gt;= 0 &amp;&amp; x &lt; board[0].length)</span>
<span class="nc" id="L81">                board[y][x] = 1;</span>
        }
<span class="nc" id="L83">    }</span>

    private int[][] copyBoard(int[][] board) {
<span class="nc" id="L86">        int[][] copy = new int[board.length][board[0].length];</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        for (int i = 0; i &lt; board.length; i++)</span>
<span class="nc" id="L88">            System.arraycopy(board[i], 0, copy[i], 0, board[i].length);</span>
<span class="nc" id="L89">        return copy;</span>
    }

    private int evaluateBoard(int[][] board) {
<span class="nc" id="L93">        int clearedLines = 0;</span>
<span class="nc" id="L94">        int height = 0;</span>
<span class="nc" id="L95">        int holes = 0;</span>

<span class="nc bnc" id="L97" title="All 2 branches missed.">        for (int y = 0; y &lt; board.length; y++) {</span>
<span class="nc" id="L98">            boolean full = true;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            for (int x = 0; x &lt; board[0].length; x++) {</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (board[y][x] == 0) full = false;</span>
            }
<span class="nc bnc" id="L102" title="All 2 branches missed.">            if (full) clearedLines++;</span>
        }

<span class="nc bnc" id="L105" title="All 2 branches missed.">        for (int x = 0; x &lt; board[0].length; x++) {</span>
<span class="nc" id="L106">            boolean blockFound = false;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            for (int y = 0; y &lt; board.length; y++) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if (board[y][x] == 1) { blockFound = true; height += (board.length - y); }</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                else if (blockFound) holes++;</span>
            }
        }

<span class="nc" id="L113">        return clearedLines * 100 - height - holes * 10;</span>
    }

    public static class Move {
        public final int column;
        public final int row;
        public final int rotation;
<span class="nc" id="L120">        public Move(int column, int row, int rotation) {</span>
<span class="nc" id="L121">            this.column = column;</span>
<span class="nc" id="L122">            this.row = row;</span>
<span class="nc" id="L123">            this.rotation = rotation;</span>
<span class="nc" id="L124">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>